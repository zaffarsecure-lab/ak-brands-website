<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AK Brands - Admin Panel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root { --primary: #4f46e5; --secondary: #64748b; --success: #10b981; --danger: #ef4444; --warning: #f59e0b; }
        body { font-family: 'Inter', sans-serif; background: #f8fafc; margin: 0; padding: 20px; }
        .container { max-width: 1250px; margin: 0 auto; background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .export-btns { display: flex; gap: 10px; }
        
        /* Filters Section */
        .filter-section { display: flex; gap: 15px; flex-wrap: wrap; background: #f1f5f9; padding: 15px; border-radius: 12px; margin-bottom: 20px; align-items: flex-end; }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        .filter-group label { font-size: 11px; font-weight: 700; color: var(--secondary); text-transform: uppercase; }
        .input-field { padding: 10px; border-radius: 8px; border: 1px solid #cbd5e1; outline: none; font-size: 14px; }
        .search-box { flex-grow: 1; min-width: 250px; }

        .btn { padding: 10px 18px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 14px; color: white; }
        .btn-add { background: var(--primary); }
        .btn-excel { background: #166534; }
        .btn-pdf { background: #1e293b; }
        .btn-reset { background: #64748b; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; background: #f8fafc; color: var(--secondary); font-size: 12px; text-transform: uppercase; padding: 15px; border-bottom: 2px solid #e2e8f0; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 14px; color: #1e293b; }
        
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
        .status-available { background: #dcfce7; color: #166534; }
        .status-sold { background: #fee2e2; color: #991b1b; }
        
        .action-btns { display: flex; gap: 5px; }
        .act-btn { padding: 6px 10px; border-radius: 5px; border: none; font-size: 12px; font-weight: 600; color: white; cursor: pointer; }
        .copy { background: #10b981; }
        .status { background: #f59e0b; }
        .delete { background: #ef4444; }
    </style>
</head>
<body>

<div class="container">
    <div class="top-bar">
        <h2>ðŸ“¦ AK Brands Inventory</h2>
        <div class="export-btns">
            <button class="btn btn-excel" onclick="exportFilteredExcel()">Excel Export</button>
            <button class="btn btn-pdf" onclick="exportToPDF()">PDF Report</button>
        </div>
    </div>

    <button class="btn btn-add" style="margin-bottom: 15px;" onclick="window.location.href='add-lot.html'">+ Add New Lot</button>

    <div class="filter-section">
        <div class="filter-group search-box">
            <label>Search Inventory</label>
            <input type="text" id="searchInput" class="input-field" placeholder="Search Lot #, Category, Location..." onkeyup="applyFilters()">
        </div>
        <div class="filter-group">
            <label>From Date</label>
            <input type="date" id="fromDate" class="input-field" onchange="applyFilters()">
        </div>
        <div class="filter-group">
            <label>To Date</label>
            <input type="date" id="toDate" class="input-field" onchange="applyFilters()">
        </div>
        <button class="btn btn-reset" onclick="resetFilters()">Reset</button>
    </div>

    <table id="inventoryTable">
        <thead>
            <tr>
                <th>Lot #</th>
                <th>Category</th>
                <th>Qty</th>
                <th>Location</th>
                <th>Date Added</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="inventoryBody">
            </tbody>
    </table>
</div>

<script>
    const DB_URL = "https://ak-brands-marketing-default-rtdb.firebaseio.com/inventory.json";
    let fullInventory = []; // Master Data
    let filteredData = []; // Data currently shown

    async function loadInventory() {
        const res = await fetch(DB_URL);
        const data = await res.json();
        
        fullInventory = Object.keys(data).map(key => ({ id: key, ...data[key] }));
        
        // Initial Sort: Latest Lot First
        fullInventory.sort((a, b) => (parseInt(b.lotNumber) || 0) - (parseInt(a.lotNumber) || 0));
        
        filteredData = [...fullInventory];
        renderTable(filteredData);
    }

    function renderTable(dataToRender) {
        const body = document.getElementById('inventoryBody');
        body.innerHTML = "";

        dataToRender.forEach(item => {
            const statusClass = item.status === "SOLD" ? "status-sold" : "status-available";
            // Formatting date for display (assuming your 'date' field is YYYY-MM-DD)
            const displayDate = item.date || 'N/A';
            
            body.innerHTML += `
                <tr>
                    <td style="color: #4f46e5; font-weight: 700;">${item.lotNumber}</td>
                    <td>${item.category}</td>
                    <td>${item.quantity} ${item.unit}</td>
                    <td>${item.location || 'Surat'}</td>
                    <td>${displayDate}</td>
                    <td><span class="badge ${statusClass}">${item.status || 'AVAILABLE'}</span></td>
                    <td class="action-btns">
                        <button class="act-btn copy" onclick="copyLink('${item.lotNumber}')">Link</button>
                        <button class="act-btn status" onclick="toggleStatus('${item.id}', '${item.status}')">Status</button>
                        <button class="act-btn delete" onclick="deleteLot('${item.id}')">Del</button>
                    </td>
                </tr>
            `;
        });
    }

    // --- CONSOLIDATED FILTER LOGIC ---
    function applyFilters() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const from = document.getElementById('fromDate').value;
        const to = document.getElementById('toDate').value;

        filteredData = fullInventory.filter(item => {
            const matchesSearch = item.lotNumber.toString().toLowerCase().includes(query) ||
                                 item.category.toLowerCase().includes(query) ||
                                 (item.location && item.location.toLowerCase().includes(query));
            
            let matchesDate = true;
            if (item.date) {
                if (from && item.date < from) matchesDate = false;
                if (to && item.date > to) matchesDate = false;
            } else if (from || to) {
                matchesDate = false; // Hide items with no date if a date filter is active
            }

            return matchesSearch && matchesDate;
        });

        renderTable(filteredData);
    }

    function resetFilters() {
        document.getElementById('searchInput').value = "";
        document.getElementById('fromDate').value = "";
        document.getElementById('toDate').value = "";
        filteredData = [...fullInventory];
        renderTable(filteredData);
    }

    // --- EXCEL EXPORT (Respects Filters) ---
    function exportFilteredExcel() {
        // Exporting filtered data so you can get specific month reports
        const exportSet = filteredData.map(({ id, ...rest }) => rest);
        const ws = XLSX.utils.json_to_sheet(exportSet);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Inventory_Extract");
        XLSX.writeFile(wb, `AK_Inventory_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
    }

    // --- PDF REPORT ---
    function exportToPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("AK Brands Inventory Status Report", 14, 15);
        doc.autoTable({
            html: '#inventoryTable',
            startY: 25,
            theme: 'striped',
            headStyles: { fillColor: [79, 70, 229] }
        });
        doc.save("AK_Inventory_Report.pdf");
    }

    async function toggleStatus(id, currentStatus) {
        const newStatus = currentStatus === "SOLD" ? "AVAILABLE" : "SOLD";
        await fetch(`https://ak-brands-marketing-default-rtdb.firebaseio.com/inventory/${id}.json`, {
            method: 'PATCH',
            body: JSON.stringify({ status: newStatus })
        });
        loadInventory();
    }

    async function deleteLot(id) {
        if(confirm("Permanently delete this lot?")) {
            await fetch(`https://ak-brands-marketing-default-rtdb.firebaseio.com/inventory/${id}.json`, { method: 'DELETE' });
            loadInventory();
        }
    }

    function copyLink(lotNum) {
        const link = `https://akbrandsmarketing.com/lot-details.html?lotNumber=${encodeURIComponent(lotNum)}`;
        navigator.clipboard.writeText(link).then(() => alert("âœ… Link Copied!"));
    }

    loadInventory();
</script>
</body>
</html>
