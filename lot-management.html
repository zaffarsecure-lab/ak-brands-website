<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AK Brands - Master Admin</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #4f46e5; --secondary: #64748b; --success: #10b981; --danger: #ef4444; --ak-dark: #1e293b; --wa-green: #25d366; --warn: #f59e0b; }
        body { font-family: 'Inter', sans-serif; background: #f1f5f9; margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        
        /* Layout & Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 25px; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
        .tab-btn { padding: 12px 24px; border-radius: 10px; border: none; background: transparent; cursor: pointer; font-weight: 700; color: var(--secondary); transition: 0.3s; }
        .tab-btn.active { background: var(--primary); color: white; }

        /* Dashboard Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .stat-card { background: white; padding: 20px; border-radius: 15px; border: 1px solid #e2e8f0; text-align: center; }
        .stat-val { font-size: 24px; font-weight: 900; color: var(--ak-dark); }
        .stat-label { font-size: 12px; color: var(--secondary); text-transform: uppercase; margin-top: 5px; }

        /* Controls */
        .controls { display: flex; flex-wrap: wrap; gap: 15px; background: #f8fafc; padding: 20px; border-radius: 15px; margin-bottom: 20px; align-items: flex-end; }
        .input-group { display: flex; flex-direction: column; gap: 5px; flex-grow: 1; }
        label { font-size: 11px; font-weight: 800; color: var(--secondary); text-transform: uppercase; }
        input, select, textarea { padding: 12px; border-radius: 8px; border: 1px solid #cbd5e1; outline: none; font-family: inherit; }

        .btn { padding: 12px 20px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; color: white; transition: 0.2s; }
        .btn-add { background: var(--primary); }
        .btn-excel { background: #166534; }
        
        /* Table Styling */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; background: #f8fafc; padding: 15px; font-size: 12px; color: var(--secondary); text-transform: uppercase; border-bottom: 2px solid #e2e8f0; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
        .lot-link { color: #4f46e5; text-decoration: none; font-weight: 800; cursor: pointer; }
        .lot-link:hover { text-decoration: underline; }

        .badge { padding: 5px 10px; border-radius: 6px; font-size: 11px; font-weight: 800; }
        .status-available { background: #dcfce7; color: #166534; }
        .status-sold { background: #fee2e2; color: #991b1b; }
        
        .view-section { display: none; }
        .view-section.active { display: block; }

        /* Actions */
        .action-btn { padding: 6px 10px; border-radius: 6px; border: none; color: white; cursor: pointer; font-size: 12px; font-weight: bold; margin-right: 2px; }
        .btn-copy { background: var(--success); }
        .btn-status { background: var(--warn); }
        .btn-del { background: var(--danger); }

        /* Modal Overlay */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 20px; width: 95%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
    </style>
</head>
<body>

<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>ðŸ“¦ AK Brands Inventory Suite</h2>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-excel" onclick="exportData()">Excel Export</button>
        </div>
    </div>

    <div class="tabs">
        <button id="tab-inventory" class="tab-btn active" onclick="switchTab('inventory')">ðŸ“¦ Inventory</button>
        <button id="tab-customers" class="tab-btn" onclick="switchTab('customers')">ðŸ‘¥ Customers</button>
        <button id="tab-suppliers" class="tab-btn" onclick="switchTab('suppliers')">ðŸš› Suppliers</button>
    </div>

    <div class="stats-grid">
        <div class="stat-card"><div class="stat-val" id="totalLots">0</div><div class="stat-label">Total Lots</div></div>
        <div class="stat-card"><div class="stat-val" id="totalStockVal">â‚¹0</div><div class="stat-label">Estimated Value</div></div>
        <div class="stat-card"><div class="stat-val" id="pendingFollowups" style="color:var(--danger)">0</div><div class="stat-label">Pending Follow-ups</div></div>
    </div>

    <div class="controls">
        <div class="input-group" style="flex-grow: 2;"><label>Search Database</label><input type="text" id="masterSearch" placeholder="Search Lot #, Category, Location..." onkeyup="applyFilters()"></div>
        <button class="btn btn-add" id="actionBtn" onclick="openModal()">+ Add New Lot</button>
    </div>

    <div id="inventorySection" class="view-section active">
        <table>
            <thead><tr><th>Lot #</th><th>Category</th><th>Qty</th><th>Location</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody id="inventoryBody"></tbody>
        </table>
    </div>

    <div id="customersSection" class="view-section">
        <table>
            <thead><tr><th>Name</th><th>Phone</th><th>Category</th><th>Follow-up</th><th>Actions</th></tr></thead>
            <tbody id="customerBody"></tbody>
        </table>
    </div>

    <div id="suppliersSection" class="view-section">
        <table>
            <thead><tr><th>Company</th><th>Person</th><th>Category</th><th>Rating</th><th>Actions</th></tr></thead>
            <tbody id="supplierBody"></tbody>
        </table>
    </div>
</div>

<div id="inventoryModal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3>ðŸ“¦ Add New Inventory Lot</h3>
            <button onclick="closeModal('inventoryModal')" style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
        </div>
        <form id="lotForm" onsubmit="saveEntry(event, 'inventory')">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <div class="input-group"><label>Lot Number</label><input type="text" name="lotNumber" required placeholder="e.g. 14684"></div>
                <div class="input-group"><label>Category</label><input type="text" name="category" required placeholder="e.g. Mens T-Shirt"></div>
                <div class="input-group"><label>Quantity</label><input type="text" name="quantity" required placeholder="e.g. 500 Pieces"></div>
                <div class="input-group"><label>Location</label><input type="text" name="location" required placeholder="e.g. Surat"></div>
                <div class="input-group"><label>AK Rate (for Valuation)</label><input type="number" name="akOffer" required placeholder="0.00"></div>
                <div class="input-group"><label>Status</label>
                    <select name="status"><option value="AVAILABLE">AVAILABLE</option><option value="SOLD">SOLD</option></select>
                </div>
            </div>
            <br>
            <button type="submit" class="btn btn-add" style="width: 100%;">Save Lot to Database</button>
        </form>
    </div>
</div>

<div id="customerModal" class="modal"><div class="modal-content"><h3>ðŸ‘¥ New Customer</h3><form onsubmit="saveEntry(event, 'customers')"><input type="text" name="name" placeholder="Name" required style="width:100%; margin-bottom:10px;"><input type="tel" name="phone" placeholder="91..." required style="width:100%; margin-bottom:10px;"><input type="date" name="followup" style="width:100%; margin-bottom:20px;"><button type="submit" class="btn btn-add" style="width:100%;">Save</button></form></div></div>
<div id="supplierModal" class="modal"><div class="modal-content"><h3>ðŸš› New Supplier</h3><form onsubmit="saveEntry(event, 'suppliers')"><input type="text" name="company" placeholder="Company" required style="width:100%; margin-bottom:10px;"><input type="text" name="category" placeholder="Category" style="width:100%; margin-bottom:20px;"><button type="submit" class="btn btn-add" style="width:100%;">Save</button></form></div></div>

<script>
    const DB_URL = "https://ak-brands-marketing-default-rtdb.firebaseio.com";
    let currentTab = 'inventory';
    let rawData = { inventory: [], customers: [], suppliers: [], logs: [] };

    // LOAD DATA
    async function loadData() {
        try {
            const [inv, cust, supp, log] = await Promise.all([
                fetch(`${DB_URL}/inventory.json`).then(r => r.json()),
                fetch(`${DB_URL}/customers.json`).then(r => r.json()),
                fetch(`${DB_URL}/suppliers.json`).then(r => r.json()),
                fetch(`${DB_URL}/visitor_logs.json`).then(r => r.json())
            ]);
            rawData.inventory = Object.keys(inv || {}).map(k => ({ id: k, ...inv[k] })).sort((a,b) => b.lotNumber - a.lotNumber);
            rawData.customers = Object.keys(cust || {}).map(k => ({ id: k, ...cust[k] }));
            rawData.suppliers = Object.keys(supp || {}).map(k => ({ id: k, ...supp[k] }));
            rawData.logs = Object.values(log || {});
            updateStats(); applyFilters();
        } catch(e) { console.error("Database Error", e); }
    }

    // TAB SWITCHING
    function switchTab(t) {
        currentTab = t;
        document.querySelectorAll('.tab-btn, .view-section').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-'+t).classList.add('active');
        document.getElementById(t+'Section').classList.add('active');
        const btn = document.getElementById('actionBtn');
        btn.innerText = t === 'inventory' ? "+ Add New Lot" : (t === 'customers' ? "+ Add New Customer" : "+ Add New Supplier");
        applyFilters();
    }

    // STATS
    function updateStats() {
        document.getElementById('totalLots').innerText = rawData.inventory.length;
        const totalVal = rawData.inventory.reduce((acc, curr) => acc + (parseFloat(curr.quantity) * parseFloat(curr.akOffer || 0)), 0);
        document.getElementById('totalStockVal').innerText = "â‚¹" + totalVal.toLocaleString('en-IN');
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('pendingFollowups').innerText = rawData.customers.filter(c => c.followup && c.followup <= today).length;
    }

    // TABLE RENDERING
    function applyFilters() {
        const q = document.getElementById('masterSearch').value.toLowerCase();
        const filtered = rawData[currentTab].filter(item => JSON.stringify(item).toLowerCase().includes(q));
        renderTable(filtered);
    }

    function renderTable(data) {
        const body = document.getElementById(currentTab + 'Body');
        if(currentTab === 'inventory') {
            body.innerHTML = data.map(item => `
                <tr>
                    <td><a class="lot-link" href="lot-details.html?lotNumber=${item.lotNumber}">${item.lotNumber}</a></td>
                    <td>${item.category}</td>
                    <td>${item.quantity}</td>
                    <td>${item.location}</td>
                    <td><span class="badge ${item.status === 'SOLD' ? 'status-sold' : 'status-available'}">${item.status || 'AVAILABLE'}</span></td>
                    <td>
                        <button class="action-btn btn-copy" onclick="copyMarketingLink('${item.lotNumber}')">Copy</button>
                        <button class="action-btn btn-status" onclick="toggleStatus('${item.id}', '${item.status}')">Status</button>
                        <button class="action-btn btn-del" onclick="deleteEntry('${item.id}', 'inventory')">Del</button>
                    </td>
                </tr>
            `).join('');
        } else if(currentTab === 'customers') {
            body.innerHTML = data.map(c => `<tr><td>${c.name}</td><td>${c.phone}</td><td>${c.category || ''}</td><td>${c.followup || ''}</td><td><button class="action-btn btn-del" onclick="deleteEntry('${c.id}', 'customers')">Del</button></td></tr>`).join('');
        }
    }

    // ACTIONS
    function openModal() { document.getElementById(currentTab + 'Modal').style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    async function saveEntry(e, type) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target));
        await fetch(`${DB_URL}/${type}.json`, { method: 'POST', body: JSON.stringify(data) });
        e.target.reset(); closeModal(type + 'Modal');
        loadData();
    }

    async function toggleStatus(id, current) {
        const next = current === 'SOLD' ? 'AVAILABLE' : 'SOLD';
        await fetch(`${DB_URL}/inventory/${id}.json`, { method: 'PATCH', body: JSON.stringify({ status: next }) });
        loadData();
    }

    async function deleteEntry(id, type) {
        if(confirm("Permanently delete this entry?")) {
            await fetch(`${DB_URL}/${type}/${id}.json`, { method: 'DELETE' });
            loadData();
        }
    }

    function copyMarketingLink(num) {
        const link = `https://akbrandsmarketing.com/lot-details.html?lotNumber=${num}`;
        navigator.clipboard.writeText(link).then(() => alert("Marketing Link Copied!"));
    }

    function exportData() {
        const ws = XLSX.utils.json_to_sheet(rawData[currentTab]);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, currentTab);
        XLSX.writeFile(wb, `AK_${currentTab}_Database.xlsx`);
    }

    loadData();
</script>
</body>
</html>
